---

layout : single
title : 'Callback, Promise, async&await ì‚¬ìš©í•´ë³´ê¸°'

---

## Callback

```javascript
// JavaScript is synchronous. ì •í•´ì§„ ìˆœì„œì— ë§žê²Œ ì‹¤í–‰ ëœë‹¤. 
// Execute the code block in order after hoisting.
// í˜¸ì´ìŠ¤íŒ…ì´ ëœ ì´í›„ ë¶€í„°, ì½”ë“œê°€ ë‚˜íƒ€ë‚œ ìˆœì„œëŒ€ë¡œ ì§„í–‰ëœë‹¤. 
// hoisting: var, function declarationì´ ì œì¼ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” ê²ƒ 

console.log('1');
console.log('2');
console.log('3');

// ê²°ê³¼ 1 2 3
```


```javascript
// Asynchronous ì–¸ì œ ì½”ë“œê°€ ì‹¤í–‰ë ì§€ ì•Œ ìˆ˜ ì—†ìŒ 
console.log('1');
// Callback : ë‹¤ì‹œ ë¶€ë¥¼ í•¨ìˆ˜, arrow function, 1ì´ˆê°€ ì§€ë‚œ ë‹¤ìŒ ì‹¤í–‰
setTimeout(() => console.log('2'), 1000);
console.log('3');
// ì‹¤í–‰ê²°ê³¼ 1 3 2
```



### Synchronous callback

```javascript
console.log('1');
setTimeout(() => console.log('2'), 1000);
console.log('3');
function printImmediately(print) {
  print();
}
printImmediately(() => console.log('hello'));


// ì‹¤í–‰ê²°ê³¼ 1 3 hello 2 
```



### Asynchronous callback

```javascript
console.log('1');
setTimeout(() => console.log('2'), 1000);
console.log('3');
function printWithDelay(print, timeout) {
  setTimeout(print, timeout);
}
printWithDelay(() => console.log('async callback'), 2000);

// ì‹¤í–‰ê²°ê³¼ 1 3 2 async callback 
```



### Callback Hell example

ë‚˜ìœ ê°€ë…ì„± ìœ ì§€ë³´ìˆ˜ Hell 

```javascript
class UserStorage {
  loginUser(id, password, onSuccess, onError) {
    setTimeout(() => {
      if (
        (id === 'moji' && password === 'qwerty123') ||
        (id === 'admin' && password === 'pwadmin')
      ) {
        onSuccess(id);
      } else {
        onError(new Error('not found'));
      }
    }, 2000);
  }

  getRoles(user, onSuccess, onError) {
    setTimeout(() => {
      if (user === 'moji') {
        onSuccess({ name: 'moji', role: 'admin' });
      } else {
        onError(new Error('no access'));
      }
    }, 1000);
  }
}

/*
	1) id, pw ìž…ë ¥ë°›ê¸°
	2) loginUser()
	3) getRoles()  
	4) onSuccess()   
*/

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage.loginUser(
  id,
  password,
  user => {
    userStorage.getRoles(
      user,
      userWithRole => {
        alert(
          `Hello ${userWithRole.name}, you have a ${userWithRole.role} role`
        );
      },
      error => {
        console.log(error);
      }
    );
  },
  error => {
    console.log(error);
  }
);
```



## Promise

>  callback í•¨ìˆ˜ ëŒ€ì‹  Promiseë¥¼ ì‚¬ìš©í•´ë³´ìž 

Promise is a JavaScript object for asynchronous operation.

> State : pending -> fulfilled or rejected 

pending(operaion ì‹¤í–‰ ì¤‘) , fulfilled(operaion ì‹¤í–‰ ì„±ê³µì .) or rejected

> Producervs Consumer : ì •ë³´ì œê³µ(Promise object)  vs Data ì‚¬ìš© ì£¼ì²´

> executor callback

* resolve : ì •ìƒì  ì‹¤í–‰ í›„ ìµœì¢… ë°ì´í„° ì „ë‹¬ ì½œë°± 

* reject : ë¬¸ì œ ë°œìƒ ì‹œ ì‹¤í–‰ 

### 1. Producer

```javascript
// [ì£¼ì˜] í”„ë¡œë¯¸ìŠ¤ ìƒì„± í›„, executor ìžë™ ì‹¤í–‰
// when new Promise is created, the executor runs automatically.
const promise = new Promise((resolve, reject) => {
  // doing some heavy work (network, read files) ë¹„ë™ê¸°ì  ì²˜ë¦¬ê°€ ì¢‹ê² ì§€ 
  console.log('doing something...');
  setTimeout(() => {
    resolve('moji');
    // reject(new Error('no network'));
  }, 2000);
});
```

### 2. Consumers: then, catch, finally

```javascript
promise 
  .then(value => {
    console.log(value); // resolve moji
  })
  .catch(error => {
    console.log(error); // reject no network
  })
  .finally(() => {
    console.log('finally'); // ì„±ê³µ, ì‹¤íŒ¨ ì—¬ë¶€ ë¬´ê´€í•˜ê²Œ í•­ìƒ í˜¸ì¶œë¨ 
  });
```

### 3. Promise chaining

ì—¬ëŸ¬ ë¹„ë™ê¸° ë¬¶ì–´ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²• 

thenì€ value, promise ëª¨ë‘ ì „ë‹¬ ê°€ëŠ¥ 

```javascript
const fetchNumber = new Promise((resolve, reject) => {
  setTimeout(() => resolve(1), 1000);
});

fetchNumber
  .then(num => num * 2) // 2
  .then(num => num * 3) // 6
  .then(num => {
    return new Promise((resolve, reject) => {
      setTimeout(() => resolve(num - 1), 1000); // 5
    });
  })
  .then(num => console.log(num));

// 2ì´ˆ ì†Œìš”
```

###  4. Error Handling

```javascript
const getHen = () =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve('ðŸ“'), 1000);
  });
const getEgg = hen =>
  new Promise((resolve, reject) => {
    setTimeout(() => reject(new Error(`error! ${hen} => ðŸ¥š`)), 1000);
  });
const cook = egg =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve(`${egg} => ðŸ³`), 1000);
  });

getHen() 
  .then(getEgg) // 1
  .then(cook) 
  .then(console.log)
  .catch(console.log); // 2 
// 1ì—ì„œ ì—ëŸ¬ ë°œìƒí–ˆì§€ë§Œ 2ì—ì„œ Error ìž¡íž˜ 

// getEgg Error ì²˜ë¦¬í•´ë³´ê¸°
getHen() 
  .then(getEgg)
	.catch(error => {
  	return 'ðŸŸ'
	})
  .then(cook) 
  .then(console.log)
  .catch(console.log); 
```



### Fix Callback Hell (using Promise)

```javascript
class UserStorage {
  loginUser(id, password) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
      if (
        (id === 'moji' && password === 'qwerty123') ||
        (id === 'admin' && password === 'pwadmin')
      ) {
        resolve(id);
      } else {
        reject(new Error('not found'));
      }
    }, 2000);
    })
  }

  getRoles(user) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
      if (user === 'moji') {
        resolve({ name: 'moji', role: 'admin' });
      } else {
        reject(new Error('no access'));
      }
    }, 1000);
    })
  }
}

userStorage.loginUser(id,password)
.then(userStorage.getRoles)
.then(user => alert(`Hello ${user.name}, you have a ${user.role} role`)
.catch(console.log)
```



## async await

promise then chaning ê°œì„ í•˜ê¸° (ë™ê¸° ì½”ë“œ ì²˜ëŸ¼ ë³´ì´ê²Œ í•˜ëŠ” syntatic sugar)

### async

```javascript
//  promise ì´ìš© ì‹œ 
function fetchUser(){
  return new Promise((resolve, reject) => {
     // do network reqeust in 10 secs....
  resolve 'moji'; // return ì‹œ ê³„ì† pending ìƒíƒœ 
  })
}

const user = fetchUser(); 
user.then(console.log);
console.log(user);

```

```javascript
// async í‚¤ì›Œë“œ ì‚¬ìš© ì‹œ promise ê°ì²´ë¡œ ë³€í™˜ 
async function fetchUser() {
  // do network reqeust in 10 secs....
  return 'moji';
}

const user = fetchUser(); 
user.then(console.log);
console.log(user);

```

### await 

async ê°€ ë¶™ì€ í•¨ìˆ˜ ë‚´ì—ì„œ ì‚¬ìš© 

```javascript
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function getApple() {
  await delay(2000);
  return 'ðŸŽ';
}

async function getBanana() {
  await delay(1000);
  return 'ðŸŒ';
}

async function pickFruits() {
  const applePromise = getApple();
  const bananaPromise = getBanana();
  const apple = await applePromise;
  const banana = await bananaPromise;
  return `${apple} + ${banana}`;
}

pickFruits().then(console.log);
```

### useful APIs 

ìœ„ codeì— ë³‘ë ¬ì ìœ¼ë¡œ ìž‘ì„± ëœ ë¶€ë¶„ ê°œì„  `Promise.all`

ë¨¼ì € return ë˜ëŠ” ê²ƒì„ ë°›ì•„ì˜¤ê³  ì‹¶ì„ ë•Œ `Promise.race`

```javascript
function pickAllFruits() {
  return Promise.all([getApple(), getBanana()]).then(fruits =>
    fruits.join(' + ')
  );
}
pickAllFruits().then(console.log);

function pickOnlyOne() {
  return Promise.race([getApple(), getBanana()]);
}

pickOnlyOne().then(console.log);
```

